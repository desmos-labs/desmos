name: Release
# Release workflow builds the binaries for a release, and then publishes them to a newly created GitHub release.

on:
  # TODO: Remove this
  pull_request:
  release:
    types: [ created ]

jobs:

  build-macos:
    name: Build MacOS binary
    runs-on: macos-latest
    env:
      VERSION: ${{ git describe --always | sed 's/^v//' }}
      COMMIT: ${{ git log -1 --format='%H' }}
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Go ğŸ§°
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.15

      - name: Build the binary ğŸ­
        run: |
          make build
          mv build/desmos "artifacts/desmos-$VERSION-$COMMIT-darwin-amd64"

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'darwin-amd64'
          path: 'artifacts/*darwin*amd64*'


  build-others:
    name: Build MacOS binary
    runs-on: ubuntu-18.04
    env:
      VERSION: ${{ git describe --always | sed 's/^v//' }}
      COMMIT: ${{ git log -1 --format='%H' }}
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Go ğŸ§°
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.15

      - name: Build the binary ğŸ­
        run: |
          make build-linux
          mv build/desmos "artifacts/desmos-$VERSION-$COMMIT-linux-amd64"

          make build-arm64
          mv build/desmos "artifacts/desmos-$VERSION-$COMMIT-linux-arm64"

          make build-windows64
          mv build/desmos "artifacts/desmos-$VERSION-$COMMIT-windows-amd64"

      - name: Upload the linux/amd64 artifact ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'linux-amd64'
          path: 'artifacts/*linux*amd64*'

      - name: Upload the linux/arm64 artifact ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'darwin-arm64'
          path: 'artifacts/*linux*arm64*'

      - name: Upload the windows/amd64 artifact ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'windows-amd64'
          path: 'artifacts/*windows*amd64*'

#      - name: Release the artifacts ğŸ“¤
#        uses: skx/github-action-publish-binaries@master
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        with:
#          args: 'artifacts/desmos-*'