name: Release
# Release workflow builds the binaries for a release, and then publishes them to a newly created GitHub release.

on:
  # TODO: Remove this
  pull_request:
  release:
    types: [ created ]

jobs:
  build-macos:
    name: Build MacOS binary
    runs-on: macos-10.15
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Set variables
        run: |
          echo "VERSION=$(git describe --always | sed 's/^v//')" >> $GITHUB_ENV
          echo "COMMIT=$(git log -1 --format='%H')" >> $GITHUB_ENV

      - name: Setup Go ğŸ§°
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.15

      - name: Build the binary ğŸ­
        run: |
          LEDGER_ENABLED=true make build
          mv build/desmos "build/desmos-$VERSION-$COMMIT-darwin-amd64"

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'darwin-amd64'
          path: 'build/*darwin*amd64*'

  build-linux:
    name: Build Linux binaries
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        go-arch: [ "amd64", "arm64" ]
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Set variables
        run: |
          echo "VERSION=$(git describe --always | sed 's/^v//')" >> $GITHUB_ENV
          echo "COMMIT=$(git log -1 --format='%H')" >> $GITHUB_ENV

      - name: Setup Go ğŸ§°
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.15

      - name: Compute diff ğŸ“œ
        uses: technote-space/get-diff-action@v4
        id: git_diff
        with:
          PATTERNS: |
            **/**.go
            go.mod
            go.sum

      - name: Build ğŸ”¨
        run: |
          GOARCH=${{ matrix.go-arch }} LEDGER_ENABLED=true make build
          mv build/desmos "build/desmos-$VERSION-$COMMIT-linux-${{ matrix.go-arch }}"

      - name: Upload the linux/amd64 artifact ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'linux-amd64'
          path: 'build/*linux*amd64*'

      - name: Upload the linux/arm64 artifact ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'linux-arm64'
          path: 'build/*linux*arm64*'


  build-windows:
    name: Build Windows binary
    runs-on: windows-latest
    steps:
      - name: Setting up dependencies
        run: |
          choco install make


      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Set variables
        run: |
          echo "VERSION=$(git describe --always | sed 's/^v//')" >> $GITHUB_ENV
          echo "COMMIT=$(git log -1 --format='%H')" >> $GITHUB_ENV

      - name: Setup Go ğŸ§°
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.15

      - name: Build the binary ğŸ­
        run: |
          LEDGER_ENABLED=true make build
          mv build/desmos "build/desmos-$VERSION-$COMMIT-windows-amd64"

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: 'windows-amd64'
          path: 'build/*windows*amd64*'

#      - name: Release the artifacts ğŸ“¤
#        uses: skx/github-action-publish-binaries@master
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        with:
#          args: 'artifacts/desmos-*'