"use strict";(self.webpackChunkdesmos_docs=self.webpackChunkdesmos_docs||[]).push([[71030],{3905:(e,s,t)=>{t.d(s,{Zo:()=>u,kt:()=>c});var n=t(67294);function i(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}function r(e,s){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);s&&(n=n.filter((function(s){return Object.getOwnPropertyDescriptor(e,s).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var s=1;s<arguments.length;s++){var t=null!=arguments[s]?arguments[s]:{};s%2?r(Object(t),!0).forEach((function(s){i(e,s,t[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(t,s))}))}return e}function a(e,s){if(null==e)return{};var t,n,i=function(e,s){if(null==e)return{};var t,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],s.indexOf(t)>=0||(i[t]=e[t]);return i}(e,s);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],s.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=n.createContext({}),p=function(e){var s=n.useContext(l),t=s;return e&&(t="function"==typeof e?e(s):o(o({},s),e)),t},u=function(e){var s=p(e.components);return n.createElement(l.Provider,{value:s},e.children)},m={inlineCode:"code",wrapper:function(e){var s=e.children;return n.createElement(n.Fragment,{},s)}},d=n.forwardRef((function(e,s){var t=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,u=a(e,["components","mdxType","originalType","parentName"]),d=p(t),c=i,h=d["".concat(l,".").concat(c)]||d[c]||m[c]||r;return t?n.createElement(h,o(o({ref:s},u),{},{components:t})):n.createElement(h,o({ref:s},u))}));function c(e,s){var t=arguments,i=s&&s.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=d;var a={};for(var l in s)hasOwnProperty.call(s,l)&&(a[l]=s[l]);a.originalType=e,a.mdxType="string"==typeof e?e:i,o[1]=a;for(var p=2;p<r;p++)o[p]=t[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,t)}d.displayName="MDXCreateElement"},10275:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>p,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>u});t(67294);var n=t(3905);function i(){return i=Object.assign||function(e){for(var s=1;s<arguments.length;s++){var t=arguments[s];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},i.apply(this,arguments)}function r(e,s){if(null==e)return{};var t,n,i=function(e,s){if(null==e)return{};var t,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],s.indexOf(t)>=0||(i[t]=e[t]);return i}(e,s);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],s.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}const o={},a="ADR 014: Improve the permission system",l={unversionedId:"architecture/adr-014-improve-permissions",id:"architecture/adr-014-improve-permissions",title:"ADR 014: Improve the permission system",description:"Changelog",source:"@site/docs/architecture/adr-014-improve-permissions.md",sourceDirName:"architecture",slug:"/architecture/adr-014-improve-permissions",permalink:"/architecture/adr-014-improve-permissions",draft:!1,editUrl:"https://github.com/desmos-labs/desmos/tree/master/docs/docs/architecture/adr-014-improve-permissions.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"ADR 013: Per-chain default external address",permalink:"/architecture/adr-013-per-chain-default-address"},next:{title:"ADR 015: Improve chain links signature support",permalink:"/architecture/adr-015-improve-chain-link-signature-support"}},p={},u=[{value:"Changelog",id:"changelog",level:2},{value:"Status",id:"status",level:2},{value:"Abstract",id:"abstract",level:2},{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Types",id:"types",level:3},{value:"<code>UserGroup</code>",id:"usergroup",level:4},{value:"<code>UserPermission</code>",id:"userpermission",level:4},{value:"<code>Msg</code> Service",id:"msg-service",level:3},{value:"<code>Query</code> Service",id:"query-service",level:4},{value:"Consequences",id:"consequences",level:2},{value:"Backwards Compatibility",id:"backwards-compatibility",level:3},{value:"Positive",id:"positive",level:3},{value:"Negative",id:"negative",level:3},{value:"Neutral",id:"neutral",level:3},{value:"Further Discussions",id:"further-discussions",level:2},{value:"Test Cases",id:"test-cases",level:2},{value:"References",id:"references",level:2}],m={toc:u};function d(e){var{components:s}=e,t=r(e,["components"]);return(0,n.kt)("wrapper",i({},m,t,{components:s,mdxType:"MDXLayout"}),(0,n.kt)("h1",i({},{id:"adr-014-improve-the-permission-system"}),"ADR 014: Improve the permission system"),(0,n.kt)("h2",i({},{id:"changelog"}),"Changelog"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"May 19th, 2022: First draft;")),(0,n.kt)("h2",i({},{id:"status"}),"Status"),(0,n.kt)("p",null,"ACCEPTED Implemented"),(0,n.kt)("h2",i({},{id:"abstract"}),"Abstract"),(0,n.kt)("p",null,"This ADR introduces a new way of registering and managing permissions within the ",(0,n.kt)("inlineCode",{parentName:"p"},"x/subspaces")," module all the other modules that depend on it."),(0,n.kt)("h2",i({},{id:"context"}),"Context"),(0,n.kt)("p",null,"Currently, Desmos implements a permission system that is very similar to the one used within Linux-based systems: each permission is represented by an ",(0,n.kt)("inlineCode",{parentName:"p"},"uint")," value treated reading its bits individually. The combination of a permission is thus obtained using the ",(0,n.kt)("inlineCode",{parentName:"p"},"|")," operator, and to check if a specific permission is set it's sufficient to check the value of the associated bit. Although this works, it has some limitations to it:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"clients need to know the value of each permission, and how to properly combine them to form the final permission value they want to set;"),(0,n.kt)("li",{parentName:"ul"},"permission values that are given from outside (e.g. a client setting a permission for a user) need to be sanitized in order to grant forward-compatibility;"),(0,n.kt)("li",{parentName:"ul"},"all permissions need to be put inside the ",(0,n.kt)("inlineCode",{parentName:"li"},"x/subspaces")," module, so that a proper validity mask can be computed and used to sanitize permissions values.")),(0,n.kt)("h2",i({},{id:"decision"}),"Decision"),(0,n.kt)("p",null,"To allow for an easier way of managing permissions, we will change the entire permission system from being based on a bitwise system to be based on a more human-readable system. Instead of representing each permission value as a ",(0,n.kt)("inlineCode",{parentName:"p"},"uint")," and then reading individual bits, we will represent each permission using a ",(0,n.kt)("inlineCode",{parentName:"p"},"string")," value that can easily tell what the permission is about. Here are some examples:"),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-go"}),'package types\n\ntype Permission string\n\nconst (\n    PermissionManageSubspace Permission = "PERMISSION_MANAGE_SUBSPACE"\n    PermissionEverything     Permission = "PERMISSION_EVERYTHING"\n)\n')),(0,n.kt)("p",null,"In order to properly support any kind of permission from different modules, we will implement the following method within the ",(0,n.kt)("inlineCode",{parentName:"p"},"x/subspaces")," module:"),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-go"}),'var (\n    // registeredPermissions represents the list of permissions that are registered and should be considered valid\n    registeredPermissions []Permission\n)\n\n// RegisterPermission allows to register the permission with the given name and returns its value\nfunc RegisterPermission(permissionName string) Permission {\n    permission := Permission(strings.ToUpper(strings.ReplaceAll(permissionName, " ", "_")))\n    for _, registeredPermission := range registeredPermissions {\n        if registeredPermission == permission {\n            panic(fmt.Errorf("permission %s has already been registered", permission))\n        }\n    }\n\n    registeredPermissions = append(registeredPermissions, permission)\n    return permission\n}\n')),(0,n.kt)("p",null,"This will allow all modules to register whatever permission they want, and then use them freely while performing checks: "),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-go"}),'// Define the permissions for the posts module\nvar (\n    PermissionCreatePost = subspacestypes.RegisterPermission("create post")\n    PermissionEditPost   = subspacestypes.RegisterPermission("edit post") \n)\n\n// Check such permissions\nkeeper.SubspacesKeeper.HasPermissions(ctx, subspaceID, user, PermissionCreatePost, PermisisonEditPost)\n')),(0,n.kt)("p",null,"When setting a user or a group's permissions, we will then require the users to provide them as a ",(0,n.kt)("inlineCode",{parentName:"p"},"string")," array, and then we simply check whether the given permissions are registered inside the supported ones or not. If they are, we store the entire array on the store.  "),(0,n.kt)("h3",i({},{id:"types"}),"Types"),(0,n.kt)("h4",i({},{id:"usergroup"}),(0,n.kt)("inlineCode",{parentName:"h4"},"UserGroup")),(0,n.kt)("p",null,"We will change the ",(0,n.kt)("inlineCode",{parentName:"p"},"UserGroup")," type to support this new permission system by replacing the ",(0,n.kt)("inlineCode",{parentName:"p"},"permissions")," field from being a ",(0,n.kt)("inlineCode",{parentName:"p"},"uint32")," to be a ",(0,n.kt)("inlineCode",{parentName:"p"},"repeated string"),": "),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-protobuf"}),'syntax = "proto3";\n\n// UserGroup represents a group of users\nmessage UserGroup {\n  // ID of the subspace inside which this group exists\n  uint64 subspace_id = 1;\n\n  // Unique id that identifies the group\n  uint32 id = 2;\n\n  // Human-readable name of the user group\n  string name = 3;\n\n  // Optional description of this group\n  string description = 4;\n\n  // Permissions that will be granted to all the users part of this group\n  repeated string permissions = 5;\n}\n')),(0,n.kt)("h4",i({},{id:"userpermission"}),(0,n.kt)("inlineCode",{parentName:"h4"},"UserPermission")),(0,n.kt)("p",null,"Instead of storing user permissions as follows: "),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{}),"UserPermissionPrefix | SubspaceID | User | -> uint32 \n")),(0,n.kt)("p",null,"We will define a new ",(0,n.kt)("inlineCode",{parentName:"p"},"UserPermission")," object: "),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-protobuf"}),'syntax = "proto3";\n\n// UserPermission contains the details of a single user permissions withing a subspace\nmessage UserPermission {\n  // Address of the user\n  bytes user = 1;\n  \n  // Permissions set to the user\n  repeated string permissions = 2;\n}\n')),(0,n.kt)("p",null,"then the permissions of a user will be stored as follows: "),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{}),"UserPermissionPrefix | SubspaceID | User | -> ProtcolBuffer(UserPermission)\n")),(0,n.kt)("h3",i({},{id:"msg-service"}),(0,n.kt)("inlineCode",{parentName:"h3"},"Msg")," Service"),(0,n.kt)("p",null,"We will change the ",(0,n.kt)("inlineCode",{parentName:"p"},"Msg")," service of the ",(0,n.kt)("inlineCode",{parentName:"p"},"x/subspaces")," module to properly allow setting permissions: "),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-protobuf"}),'syntax = "proto3";\n\n// MsgSetUserGroupPermissions represents the message used to set the permissions of a user group\nmessage MsgSetUserGroupPermissions {\n  uint64 subspace_id = 1;\n  uint32 group_id = 2;\n  repeated string permissions = 3;\n  string signer = 4;\n}\n\n// MsgSetUserPermissions represents the message used to set the permissions of a specific user\nmessage MsgSetUserPermissions {\n  uint64 subspace_id = 1;\n  string user = 2;\n  repeated string permissions = 3;\n  string signer = 4;\n}\n')),(0,n.kt)("h4",i({},{id:"query-service"}),(0,n.kt)("inlineCode",{parentName:"h4"},"Query")," Service"),(0,n.kt)("p",null,"We will change the ",(0,n.kt)("inlineCode",{parentName:"p"},"Query")," service of the ",(0,n.kt)("inlineCode",{parentName:"p"},"x/subspaces")," module to properly returns new permission values:"),(0,n.kt)("pre",null,(0,n.kt)("code",i({parentName:"pre"},{className:"language-protobuf"}),'syntax = "proto3";\n\n// QueryUserPermissionsRequest is the response type for the Query/UserPermissions method\nmessage QueryUserPermissionsResponse {\n  repeated string permissions = 1;\n  repeated PermissionDetail details = 2;\n}\n')),(0,n.kt)("h2",i({},{id:"consequences"}),"Consequences"),(0,n.kt)("h3",i({},{id:"backwards-compatibility"}),"Backwards Compatibility"),(0,n.kt)("p",null,"The above detailed solution is ",(0,n.kt)("strong",{parentName:"p"},"not")," backward compatible. For this reason, we will need to write a migration code that reads all the currently set permissions and performs the following operations: "),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"split the permission value into individual permissions;"),(0,n.kt)("li",{parentName:"ul"},"map each individual permission to the new ",(0,n.kt)("inlineCode",{parentName:"li"},"Permission")," type; "),(0,n.kt)("li",{parentName:"ul"},"replace the current store values with the new ",(0,n.kt)("inlineCode",{parentName:"li"},"Permission")," values. ")),(0,n.kt)("p",null,"This will need to be performed for all user groups as well as all individual user permissions. "),(0,n.kt)("h3",i({},{id:"positive"}),"Positive"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Allows to define permission in all modules"),(0,n.kt)("li",{parentName:"ul"},"No need to sanitize the values received from clients"),(0,n.kt)("li",{parentName:"ul"},"Easier permission setting from clients (values are now human-readable)")),(0,n.kt)("h3",i({},{id:"negative"}),"Negative"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Storing ",(0,n.kt)("inlineCode",{parentName:"li"},"string")," instead of ",(0,n.kt)("inlineCode",{parentName:"li"},"uint")," takes up more storage space  ")),(0,n.kt)("h3",i({},{id:"neutral"}),"Neutral"),(0,n.kt)("h2",i({},{id:"further-discussions"}),"Further Discussions"),(0,n.kt)("p",null,"In the future, we might even allow developers to register custom permissions within their own subspaces, and then request those permissions during the execution of different messages. This could be done by allowing them to specify a ",(0,n.kt)("inlineCode",{parentName:"p"},"MsgTypeURL -> []Permission")," entry for each kind of message type, so that when a message with ",(0,n.kt)("inlineCode",{parentName:"p"},"MsgTypeURL")," gets executed, the user needs to have the specified permission in order to successfully perform the request."),(0,n.kt)("h2",i({},{id:"test-cases"}),"Test Cases"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Migrating from old permissions to new permissions work properly and no data is lost")),(0,n.kt)("h2",i({},{id:"references"}),"References"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Issue ",(0,n.kt)("a",i({parentName:"li"},{href:"https://github.com/desmos-labs/desmos/issues/800"}),"#800")),(0,n.kt)("li",{parentName:"ul"},"Issue ",(0,n.kt)("a",i({parentName:"li"},{href:"https://github.com/desmos-labs/desmos/issues/855"}),"#855"))))}d.isMDXComponent=!0}}]);